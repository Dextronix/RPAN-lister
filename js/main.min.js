var streams=[],barn=new Barn(localStorage);checkdarkmode(),checkar(),barn.condense();function checkdarkmode(){$("html").toggleClass("darkmode",barn.get("setting_darkmode")||!1)}function checkar(){var a=barn.get("setting_refresh")||!1,b=barn.get("setting_interval")||10;if(a)setInterval(function(){refreshData()},1e3*b)}$(document).ready(function(){$.ajaxSetup({cache:!1})}),String.prototype.TrimToLen=function(a){return this.length>a?this.substring(0,a)+"...":this};var BSmode=barn.get("setting_BSmode"),sort=barn.get("sort_sort"),isAsc=barn.get("sort_isAsc"),sortindex=-1,Elemindex=barn.get("sort_Elemindex");if(BSmode&&$("#resulttable thead tr").html("<th>#</th><th sortby=\"title\"><a>Stream</a></th><th sortby=\"subreddit\"><a>Subreddit</a></th><th sortby=\"username\"><a>Username</a></th>\t<th sortby=\"contviews\"><a>Viewers</a></th><th sortby=\"upvotes\"><a>Upvotes</a></th><th sortby=\"downvotes\"><a>Downvotes</a></th><th sortby=\"comments\"><a>Comments</a></th><th sortby=\"timeon\"><a>On for</a></th><th sortby=\"timeleft\"><a>Time Left</a></th></tr>"),""!==sort&&0<Elemindex){let a=$("tr th");isAsc?(a.eq(Elemindex).addClass("down"),sortindex=0):(a.eq(Elemindex).addClass("up"),sortindex=1)}$("tr th").dblclick(function(){$(this).attr("sortby")==sort&&2>sortindex?(sortindex++,sort=$(this).attr("sortby")):(sortindex=0,sort=$(this).attr("sortby")),$("tr th").each(function(){$(this).removeClass()}),0==sortindex?($(this).addClass("down"),isAsc=!0):1==sortindex?($(this).addClass("up"),isAsc=!1):sort="",barn.set("sort_Elemindex",$(this).index()),barn.set("sort_isAsc",isAsc),barn.set("sort_sort",sort),s_refreshData()}),window.addEventListener("keydown",function(a){"j"===a.key&&(BSmode=!BSmode,barn.set("setting_BSmode",BSmode),BSmode?(alert("BSmode activated\nRefreshing..."),location.reload()):(alert("BSmode deactivated\nRefreshing..."),barn.set("sort_sort",""),location.reload())),13===a.keyCode&&alert("Coded by StoneIncarnate!"),27===a.keyCode&&refreshData(),(a.ctrlKey||a.metaKey)&&88==a.keyCode&&console.log(`DEBUG VALUES:\nHighlighted users: ${barn.smembers("highlitUsers")}\nHidden users: ${barn.smembers("hiddenUsers")||"none"}\nSort: ${barn.get("sort_sort")}\nisAsc: ${barn.get("sort_isAsc")}\nElemindex: ${barn.get("sort_Elemindex")}`)});function getList(a){if(0==a)return barn.smembers("highlitUsers")||[];return 1==a?barn.smembers("hiddenUsers")||[]:2==a?barn.smembers("hiddenSubs")||[]:3==a?JSON.parse(barn.get("setting_trash")):void 0}function openTab(a){window.open(a,"_blank")}function formatTime(a){var b=~~(a/3600),c=~~(a%3600/60),d=~~a%60,e="";return 0<b&&(e+=""+b+":"+(10>c?"0":"")),e+=""+c+":"+(10>d?"0":""),e+=""+d,e}function refreshData(){streams=[],parseStreams()}function s_refreshData(){listStreams(sort,isAsc)}function parseStreams(){$("#tableFLIP").empty(),$("table tbody").append("Loading stream data...");let a=barn.smembers("highlitUsers")||[];$.getJSON("https://strapi.reddit.com/broadcasts").done(function(b){$("#tableFLIP").empty(),$.each(b.data,function(b,c){let d=c.post,e=d.commentCount||"0",f=d.url||"error",g=d.title||"error",h=d.subreddit.name||"error",i=d.authorInfo.name||"error",j=c.upvotes||"0",k=c.downvotes||"0",l=c.broadcast_time||"0",m=c.estimated_remaining_time||"0",n=c.continuous_watchers||"0",o=c.unique_watchers||"0",p=c.stream.state||"ENDED";streams.push({comments:e,state:p,link:f,title:g.toLowerCase(),subreddit:h.toLowerCase(),username:i.toLowerCase(),upvotes:j,downvotes:k,timeon:l,timeleft:m,contviews:n,highlight:a.includes(i.toLowerCase())})}),""===sort?listStreams():listStreams(sort,isAsc)}).fail(function(a){200==a.status?alert("The RPAN server appears to have been blocked by something!\nYou may need to whitelist the RPAN stream API for this site!"):500==a.status?($("#tableFLIP").empty(),$("table tbody").append(`  Error ${a.status} Refreshing...`),_.delay(function(){refreshData()},500,"later")):($("#tableFLIP").empty(),$("table tbody").append(`Error ${a.status}`))})}function listStreams(a="none",b=!0){var c;let d=_.filter(streams,a=>_.includes("IS_LIVE",a.state)),e=_.reject(d,a=>_.includes(barn.smembers("hiddenUsers"),a.username)),f=_.reject(e,a=>_.includes(barn.smembers("hiddenSubs"),a.subreddit));c=1==b?"asc":"desc",master_index=0,"none"===a?(obj=f,console.log("Not ordering")):(obj=_.orderBy(f,a,c),console.log("Ordering by "+a+", "+c)),$("#tableFLIP").empty(),$.each(obj,function(a,b){var c="";c=BSmode?`<tr class="result${b.highlight?" marked\"":""}"><td>${a+1}</td><td data_value="streamIDhere" data_menu="stream"><a title="${b.title}"  onclick="openTab('${b.link}');">${b.title.TrimToLen(50)}</a></td><td data_value ="${b.subreddit}" data_menu="sub">r/${b.subreddit}</td><td data_value = "${b.username}" data_menu="${b.highlight?"user2":"user"}"><a onclick="openTab('https://www.reddit.com/user/${b.username}');">u/${b.username}</a></td><td>${b.contviews}</td><td>${b.upvotes}</td><td>${b.downvotes}</td><td sortby="comments">${b.comments}</td><td>${formatTime(b.timeon)}</td><td>${formatTime(b.timeleft)}</td></tr>`:`<tr class="result${b.highlight?" marked\"":""}"><td>${a+1}</td><td data_value="" data_menu="stream"><a title="${b.title}"  onclick="openTab('${b.link}');">${b.title.TrimToLen(50)}</a></td><td data_value ="${b.subreddit}" data_menu="sub">r/${b.subreddit}</td><td data_value = "${b.username}" data_menu="${b.highlight?"user2":"user"}"><a onclick="openTab('https://www.reddit.com/user/${b.username}');">u/${b.username}</a></td><td>${b.contviews}</td><td>${b.upvotes}</td><td>${b.downvotes}</td><td>${formatTime(b.timeon)}</td><td>${formatTime(b.timeleft)}</td></tr>`,$("table tbody").append(c)}),$("tr td").bind("contextmenu",function(a){a.preventDefault();var b=$(this).attr("data_value"),c=$(this).attr("data_menu");"user"==c?$(".custom-menu").html("<li data-action=\"user_hlt\">Highlight user</li><li data-action=\"user_hide\">Hide user</li>"):"user2"==c?$(".custom-menu").html("<li data-action=\"user_unhlt\">Unhighlight user</li><li data-action=\"user_hide\">Hide user</li>"):"sub"==c?$(".custom-menu").html("<li data-action=\"sub_hide\">Hide Subreddit</li>"):$(".custom-menu").html(""),$(".custom-menu").finish().toggle(100).css({top:a.pageY+"px",left:a.pageX+"px"}),$(document).bind("mousedown",function(a){0<!$(a.target).parents(".custom-menu").length&&$(".custom-menu").hide(100)}),$(".custom-menu li").click(function(){var a=$(this).attr("data-action");"user_hlt"==a?(barn.sadd("highlitUsers",b),refreshData()):"user_unhlt"==a?(barn.srem("highlitUsers",b),refreshData()):"user_hide"==a?(barn.sadd("hiddenUsers",b),refreshData()):"sub_hide"==a&&(barn.sadd("hiddenSubs",b),refreshData()),$(".custom-menu").hide(100)})})}parseStreams();